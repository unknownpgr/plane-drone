# 고정익기형 드론 설계 및 제작

고정익기형 드론을 설계하고 제작한다. 이 프로젝트는 다음과 같은 목표를 가진다.

- 최대한 저렴하고 쉽게 구할 수 있는 재료 및 부품으로 설계한다. 드론의 특성상 망가지기 쉬우므로 모든 부품은 쉽게 교체할 수 있어야 한다.
- 드론의 기능에 있어 다음과 같은 순차적인 목표를 구성할 수 있도록 설계한다.
  1. **드론의 단순 활공**: 공기 역학적으로 안정적인 드론을 구성하여 단순히 던지기만 해도 어느정도 비행하는 기체를 구성한다.
  2. **Flap을 사용한 roll 제어**: 전원을 공급하고 MCU에 기반한 flap 제어를 통해 roll 안정성을 확보한다.
  3. **Flap을 사용한 pitch 제어**: 무동력으로 드론이 급상승하거나 급하강하지 않도록 pitch 제어를 구현한다.
  4. **Thrust 제어**: 프로펠러를 사용하여 추력을 생성, 드론이 떨어지지 않도록 안정적인 비행을 구현한다.
  5. **Control fallback 구성**: 드론이 비행 중 controller와의 연결이 끊어지더라도 안전하게 착륙할 수 있도록 heartbeat를 설계하고 timeout 시 throttle을 0으로 설정한다.
  6. **방향 제어**: 드론이 원하는 방향으로 비행하도록 구성한다.
  7. **자동착륙**: 드론이 땅에 안전하게 착륙할 수 있도록 구성한다.
  8. **자동비행**: 드론이 사용자의 입력 없이 정해진 루트를 따라 자율적으로 비행할 수 있도록 구성한다.
- 일반적인 펌웨어 구성과 다르게 클린 아키텍쳐에 기반하여 localizatoin 및 control 로직을 하드웨어와 분리한다.
  - 현재 `C++`보다 `C`에 익숙한 상태이므로 먼저 C의 헤더 파일을 통하여 이를 구현하고 추후 `C++`의 `virtual` 키워드를 사용하여 코어 계층을 구성할 수 있도록 한다.

## 하드웨어 구성

- **Processor**: Arduino Uno
- **Communication**: NRF24L01
- **IMU**: MPU6050
- **GPS**: NEO-6M
- **Throttle**: BLDC 2200KV 30A
- **Flap**: SG90

## 소스 구조

- **src/src.ino**: Arduino Sketch를 사용하여 손쉽게 소스코드를 크로스 컴파일하고 업로드할 수 있도록 만든 진입점
  - 파일 이름이 `src.ino`인 것은 스케치 파일은 반드시 그 디렉토리와 이름이 같아야 하기 때문이다.
- **src/core**: 하드웨어 추상화 계층 (헤더 파일 모음)
- **src/main.cpp**: 실제 소스코드 진입점 및 주 비즈니스 로직
- **그 외 다른 파일들**: 하드웨어 추상화 계층의 구현체

> 디렉토리 구조가 레이어별로 구성되지 않은 것은 Sketch에서 include시 상대경로만을 허용하기 때문이다. 따라서 레이어별로 디렉토리를 구조화하면 `#include "../core/xxx.h"`와 같은 복잡한 상대경로를 사용해야 한다. 이러한 문제를 피하고자 우선 코어 계층만을 분리하였다.

## 제작 일지

#### 2024 / 02 / ??

- 다음 하드웨어 프로젝트로 고정익기 드론을 만들기로 결정한다.

#### 2024 / 03 / 03

- NACA Airfoil에 기반한 날개를 모델링하는 소프트웨어를 작성한다.

#### 2024 / 03 / 18

- GPS / IMU / BLDC를 구입한다.

#### 2024 / 03 / 31

- RF 통신 모듈 및 BLDC 커넥터를 구매한다.

#### 2024 / 05 / 06

- 서보 모터 및 3D 프린터를 구매한다.

#### 2024 / 05 / 30

- RF24 모듈을 테스트해본다.

- IMU를 테스트하기 위한 장치를 모델링하고 실험한다.

#### 2024 / 06 / 02

- 만능기판과 나침반 모듈을 구매한다.

#### 2024 / 06 / 15

- IMU 테스트 장치에서 임의의 입력으로부터 시스템 모델을 추정하는 알고리즘을 작성하지만, 외란으로 인해 잘 작동하지 않는다.

#### 2024 / 08 / 30

- 첫 번째 플랩 / 바디 프로토타입 설계를 시작한다.

#### 2024 / 09 / 07

- 프로토타입을 개선하여 비행기의 형상을 가지도록 구성하고 모터 및 배터리를 결선하여 비행을 테스트한다.
  - 추력이 부족하고 날개 면적이 너무 좁아 잘 날지 못한다.
- 대형 폼보드를 동체로 하는 두 번째 프로토타입 설계를 시작한다.

#### 2024 / 09 / 08

- 두 번째 프로토타입을 완료하여 출력한다.
  - 스위치와 아두이노가 너무 가까워 스위치를 끼우면 아두이노를 장치할 수 없다.
  - 스위치의 구멍이 생각보다 작게 출력되어 잘 끼워지지 않는다.
  - IMU와 아두이노의 USB 포트가 충돌한다.
  - GPS 보드의 홀 간격이 잘못 계측되어 나사 네 개를 모두 채결하는 것이 불가능하다.
  - 모터 홀더에 중심선이 있지만, 끼울 때 보이지 않는다.
  - 모터 홀더의 고정판 간격이 너무 좁아 잘 들어가지 않는다.
  - Flab의 서보 모터 결합부가 부분이 너무 좁아서 서보 모터 암이 잘 들어가지 않는다.
  - Flab의 서보 모터 결합부가 공중에 떠서 출력되므로 출력 중 수축하여 형상이 망가진다.
  - Flab holder에서 서보 모터의 선을 빼는 부분이 너무 좁아서 서보 모터가 잘 들어가지 않는다.
  - 3D 프린터의 z-offset 문제로 출력이 두어 번 실패한다.

#### 2024 / 09 / 09

- 이 레포지토리를 구성한다.
- 두 번째 프로토타입의 문제를 해결하여 출력한다.
  - 부품을 모두 바디에 장착할 수 있었다.
  - flab도 예상한 바와 같이 출력되었다. 약간 수축한 부분이 있기는 했지만 칼로 일부를 깎아내면 잘 결합된다.
  - 폼보드에 바디 및 모터를 장착하여 공기역학적으로 안정적인 위치를 찾아낸다.
  - 클린 아키텍쳐에 기반한 펌웨어 구조를 설계하고 구현한다.
  - BLDC ESC를 통한 프로세서 / 서보 전력공급 및 라디오 통신, 이에 기반한 서보 제어를 성공한다.
  - BLDC를 제어해보려고 했으나 알 수 없는 이유로 실패한다. 전압 범위 불일치로 인한 것으로 예상되는데, 일전에 제어에 성공한 적이 있기 때문에 전원장치를 끼고 테스트해볼 만하다.
